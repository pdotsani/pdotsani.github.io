<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>D3 Bar Chart from CSV</title>
      <style>
        h1, h2 {
          text-align: center;
        }

        p {
          margin: 0 auto;
          text-align: center;
          max-width: 800px;
          font-size: large;
        }

        #remittances, #remittances-pi, #gdp-unemployment {
          text-align: center;
        }
        .line {
          fill: none;
          stroke: gainsboro;
          stroke-width: 1.5;
        }

        .fillRed {
          fill: none;
          stroke: rgb(253,192,134);
          stroke-width: 1.5;
        }

        .axis-x path,
        .axis-y path {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis-x .tick line,
        .axis-y .tick line {
            stroke: black;
        }

        .axis-x line {
          stroke-opacity: 0.5;
          stroke-width: 0.5
        }

        .axis text {
            color: black;
            font-size: 12px;
        }

        .tooltip {
          fill: black;
          font-size: medium;
          pointer-events: none;
        }
      </style>
      <script src="https://d3js.org/d3.v7.min.js"></script>
      <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
      <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js" integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>
  <body>
    <h1>Remittance impact on the Filipino economy</h1>
    <!-- <h2>Global Remittances totals from 2000 to 2023</h2> -->
    <hr>
    
    <p>The world receives a significant amount of remittances from the us. Some of the top countries 
      that receive remittances include India, Mexico, France, and the Philippines. While remittances in 
      developing countries have a significant contribution to the economy, 
      remittances in more developed countries donâ€™t magnify the growth as much, but they do attract a larger volume.</p>

    <div id="remittances-global"></div>
      
    <h2>Remittances from 2000 to 2023</h2>

    <p>As we can see since 2000, growth in remittances has been steady for most countries, especially the top 5.</p>
    <div id="remittances"></div>
    
    <h2>Percent of remittances to GDP from 2000 to 2023</h2>
    <div id="remittances-pi"></div>
    
    <h2>PI Unemployment from 2000 to 2023</h2>
    <div id="gdp-unemployment"></div>

    <script>
      const widthLineChart = 800;
      const heightLineChart = 400;
      const marginLineChart = { top: 20, right: 40, bottom: 100, left: 150 };
      let parsedData = [];

      let year = d3.timeParse("%Y");

      const tooltipRemittances = d3.select("#remittances")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0)
        .style("position", "absolute")
        .style("background-color", "white")
        .style("border", "1px solid #ddd")
        .style("border-radius", "3px")
        .style("padding", "10px")
        .style("pointer-events", "none")
        .style("font-size", "12px");

      const svg = d3.select("#remittances")
        .append("svg")
        .attr("width", widthLineChart + marginLineChart.left + marginLineChart.right)
        .attr("height", heightLineChart + marginLineChart.top + marginLineChart.bottom)
        .append("g")
        .attr("transform", `translate(${marginLineChart.left},${marginLineChart.top})`);

      const remittances = "https://gist.githubusercontent.com/pdotsani/4d3756927d63f71f6dc60c17e3cdb2a9/raw/97fcc17c6b12ed4cc448facc9dcfc8c31c011ea6/remittances";
      const countriesToInclude = ["Philippines", "India", "Mexico", "France", "Nigeria"];

      d3.tsv(remittances).then(function (data) {
        const parsedData = data.map(d => ({
          value: +d.value,
          year: year(d.year),
          country: d.country
        })).filter(d =>  countriesToInclude.includes(d.country));

        console.log(parsedData);

        const countries = [...new Set(data.map((d) => d.country))];
        const timeRange = data.map((d) => year(d.year));
        const valueRange = parsedData.map((d) => +d.value);

        const y = d3.scaleLinear()
          .domain(d3.extent(valueRange))
          .nice()
          .range([heightLineChart, 0]);

        const x = d3.scaleTime()
          .domain(d3.extent(timeRange))
          .range([0, widthLineChart]);

        const scaleLine = d3.scaleOrdinal()
          .domain(countriesToInclude)
          .range(["#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3", "#a6d854"]);

        svg.append("g")
          .attr("class", "axis axis-x")
          .attr("transform", `translate(0, ${heightLineChart})`)
          .call(d3.axisBottom(x));

        svg.append("g")
          .attr("class", "axis axis-y")
          .call(d3.axisLeft(y).tickFormat(d => {
            return d3.format("$,.1f")(d / 1e9) + "B";
          }));

        // svg.append("text")
        //   .attr("class", "label")
        //   .attr("text-anchor", "middle")
        //   .attr("x", width / 2)
        //   .attr("y", height + 40)
        //   .text("Year");

        // svg.append("text")
        //   .attr("class", "label")
        //   .attr("text-anchor", "middle")
        //   .attr("transform", "rotate(-90)")
        //   .attr("x", -height / 2)
        //   .attr("y", -margin.left / 2)
        //   .text("Amount");

        const line = d3.line()
          .x(d => x(d.year))
          .y(d => y(d.value));

        for (let country of countriesToInclude) {
          const countriesData = parsedData.filter((d) => d.country == country);
          console.log("countrydata", countriesData);
          svg.append("path")
            .datum(countriesData)
            .attr("data-country", country)
            .attr("stroke-width", 2)
            .attr("d", line)
            .attr("fill", "none")
            .attr("stroke", scaleLine(country))
            
        }

        svg.selectAll("path[data-country='Philippines']")
          .raise();
      })
    </script>
    <script>
      const width = 1200;
      const height = 600;
      const margin = { top: 20, right: 40, bottom: 100, left: 150 };

      const svgMap = d3.select("#remittances-global")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const path = d3.geoPath()
      const projection = d3.geoMercator()
        .scale(100)
        .center([0, 0])
        .translate([width / 2, height / 2]);

        const tooltip = d3.select("#remittances-global")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 0)
          .style("position", "absolute")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "1px")
          .style("border-radius", "5px")
          .style("padding", "10px")
          .style("pointer-events", "none");

      
      
      const worldCloud = "https://gist.githubusercontent.com/pdotsani/1f891400eb2fbb943d3be57dc84bc5f7/raw/5e266250cfd560ca54f76e91ed587655542c7a92/world_data";
      const worldGeoJson = "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson";

      Promise.all([
        d3.tsv(worldCloud),
        d3.tsv(remittances),
        d3.json(worldGeoJson)
      ]).then(function ([world, remittances, worldJson]) {
        const data = d3.map(worldJson.features, d => d.properties);

        const worldData = [...new Set(world.map(d => ({
          code: d['Country Code'],
          country: d['Country Name'],
        })))]

        const countryCodes = {};

        worldData.forEach(d => {
          countryCodes[d.country] = d.code;
        });

        let year = d3.timeParse("%Y");
        
        const countries = [...new Set(remittances.map((d) => d.country))];
        
        const parsedData = countries.map(d => ({
          value: remittances.filter(x => x.country == d).map((d) => +d.value).reduce((a, b) => a + b, 0),
          country: d
        }));

        const sortedParsedData = parsedData.sort((a, b) => b.value - a.value);

        console.log("sortedParsedData", sortedParsedData);

        const mapData = parsedData.map(d => ({
          code: countryCodes[d.country],
          value: d.value
        }));

        worldJson.features.forEach(d => {
          const country = mapData.filter(x => x.code == d.id)[0];
          if (country == undefined) {
            d.properties.value = 0;
            return;
          }
          d.properties.value = country.value;
        });

        const valueRange = parsedData.map((d) => +d.value);

        const scale = d3.scaleQuantile()
          .domain(d3.extent(valueRange))
          .range(d3.schemeGreens[7]);

        const formatNumber = (value) => d3.format(".2s")(value).replace("G", "B")

        svgMap.append("g")
          .selectAll("path")
          .data(worldJson.features)
          .enter()
          .append("path")
          .attr("d", d3.geoPath().projection(projection))
          .attr("fill", d => scale(d.properties.value))
          .on("mouseover", function(event, d) {
            d3.select(this)
              .attr("stroke", "#000")
              .attr("stroke-width", 1.5);
            
            tooltip.transition()
              .duration(200)
              .style("opacity", 0.9);
            
            const countryName = d.properties.countryName || d.properties.name || "Unknown";
            const value = d.properties.value !== undefined ? d.properties.value : "No data";
            
            let tooltipContent = `<strong>${countryName}</strong>`;
            if (value !== "No data") {
              tooltipContent += `<br>Remittance Value: ${formatNumber(value)}`;
            } else {
              tooltipContent += "<br>No data available";
            }
            
            tooltip.html(tooltipContent)
              .style("left", (event.pageX + 15) + "px")
              .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", function() {
            d3.select(this)
              .attr("stroke", "#fff")
              .attr("stroke-width", 0.5);
            
            tooltip.transition()
              .duration(500)
              .style("opacity", 0);
          });
      })
    </script>
    <script>
      const svgRemittances = d3.select("#remittances-pi")
        .append("svg")
        .attr("width", widthLineChart + marginLineChart.left + marginLineChart.right)
        .attr("height", heightLineChart + marginLineChart.top + marginLineChart.bottom)
        .append("g")
        .attr("transform", `translate(${marginLineChart.left},${marginLineChart.top})`);

      const svgGdp = d3.select("#gdp-unemployment")
        .append("svg")
        .attr("width", widthLineChart + marginLineChart.left + marginLineChart.right)
        .attr("height", heightLineChart + marginLineChart.top + marginLineChart.bottom)
        .append("g")
        .attr("transform", `translate(${marginLineChart.left},${marginLineChart.top})`);

      const pi_data = "https://gist.githubusercontent.com/pdotsani/6e1d5ed4c1ccb04a1523beb617bba35a/raw/2622f51c3d9c523eabfc57dd751c736167730a64/world_bank_pi_data2.csv";

      d3.csv(pi_data).then(function (data) {
        console.log(data);

        const indicators = [...new Set(data.map(d => d["Indicator Name"]))];

        console.log("indicators", indicators);

        const personalRemittances = data.filter(d => d["Indicator Name"] == "Personal remittances received (% of GDP)")
          .map(d => ({
            year: d.Year,
            value: +d["Pivot Field Values"]
          })).filter(d => +d.year > 1999);
        
        const remittanceRange = personalRemittances.map((d) => d.value);
        const yRemittance = d3.scaleLinear()
          .domain(d3.extent(remittanceRange))
          .nice()
          .range([heightLineChart, 0]);
        
        const timeRange = [...new Set(personalRemittances.map((d) => year(d.year)))];
        console.log("timeRange", timeRange);
        const xRemittance = d3.scaleTime()
          .domain(d3.extent(timeRange))
          .range([0, widthLineChart]);

        const line = d3.line()
          .x(d => xRemittance(year(d.year)))
          .y(d => yRemittance(d.value));

        svgRemittances.append("g")
          .attr("class", "axis axis-x")
          .attr("transform", `translate(0, ${heightLineChart})`)
          .call(d3.axisBottom(xRemittance));

        svgRemittances.append("g")
          .attr("class", "axis axis-y")
          .call(d3.axisLeft(yRemittance));

        svgRemittances.append("path")
          .datum(personalRemittances)
          .attr("class", "line strokeRed")
          .attr("d", line);
          
        // const gdpPerCapita = data.filter(d => d["Indicator Name"] == "GDP per capita (current US$)")
        const gdpPerCapita = data.filter(d => d["Indicator Name"] == "Unemployment total (% of total labor force) (modeled ILO estimate)")
          .map(d => ({
            year: d.Year,
            value: +d["Pivot Field Values"]
          })).filter(d => +d.year > 1999);

        const gdpRange = gdpPerCapita.map((d) => d.value);

        const yGdp = d3.scaleLinear()
          .domain(d3.extent(gdpRange))
          .nice()
          .range([heightLineChart, 0]);

        const xGdp = d3.scaleTime()
          .domain(d3.extent(gdpPerCapita.map((d) => year(d.year))))
          .range([0, widthLineChart]);

        const lineGdp = d3.line()
          .x(d => xGdp(year(d.year)))
          .y(d => yGdp(d.value));

        svgGdp.append("g")
          .attr("class", "axis axis-x")
          .attr("transform", `translate(0, ${heightLineChart})`)
          .call(d3.axisBottom(xGdp));

        svgGdp.append("g")
          .attr("class", "axis axis-y")
          .call(d3.axisLeft(yGdp));

        svgGdp.append("path")
          .datum(gdpPerCapita)
          .attr("class", "line strokeRed")
          .attr("d", lineGdp);

        console.log(personalRemittances);
        console.log(gdpPerCapita);
      });
    </script>
  </body>
</html>